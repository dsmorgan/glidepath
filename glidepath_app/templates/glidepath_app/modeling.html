{% extends 'glidepath_app/base.html' %}
{% load humanize %}
{% block title %}Glidepath - Retirement Modeling{% endblock %}
{% block content %}
<div class="bg-white shadow rounded-lg p-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Retirement Modeling</h1>

    <!-- Portfolio Selection -->
    <div class="bg-gray-50 p-6 rounded-lg mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Portfolio Selection</h2>
        </div>

        {% if portfolios %}
        <form method="get" class="flex-1" id="portfolio-form">
            <select name="portfolio" onchange="this.form.submit()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">-- Select Portfolio --</option>
                {% for portfolio in portfolios %}
                <option value="{{ portfolio.id }}" {% if selected_portfolio and selected_portfolio.id == portfolio.id %}selected{% endif %}>
                    {{ portfolio.name }}
                </option>
                {% endfor %}
            </select>
        </form>
        {% else %}
        <p class="text-gray-500">No portfolios available. Please create a portfolio first.</p>
        {% endif %}
    </div>

    <!-- Error Messages -->
    {% if errors %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex">
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Errors</h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc list-inside space-y-1">
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if selected_portfolio %}
    <!-- Portfolio Information -->
    <div class="bg-blue-50 p-6 rounded-lg mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Portfolio Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <p class="text-sm text-gray-600">Current Balance</p>
                <p class="text-xl font-bold text-indigo-600 font-mono">${{ balance_info.total_balance|floatformat:2|intcomma }}</p>
                {% if balance_info.upload_date %}
                <p class="text-xs text-gray-500 mt-1">
                    As of {{ balance_info.upload_date|date:"M d, Y" }}
                    {% if balance_info.days_since_upload > 30 %}
                    <span class="text-amber-600 font-semibold">⚠ {{ balance_info.days_since_upload }} days old</span>
                    {% endif %}
                </p>
                {% endif %}
            </div>
            <div>
                <p class="text-sm text-gray-600">Current Age</p>
                <p class="text-xl font-bold text-gray-800">{{ selected_portfolio.get_current_age }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Retirement Age</p>
                <p class="text-xl font-bold text-gray-800">{{ selected_portfolio.retirement_age }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Years to Retirement</p>
                <p class="text-xl font-bold text-gray-800">{{ selected_portfolio.get_years_to_retirement }} years</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Glidepath Ruleset</p>
                <p class="text-xl font-bold text-gray-800">{{ selected_portfolio.ruleset.name|default:"Not assigned" }}</p>
            </div>
        </div>
    </div>

    <!-- Simulation Parameters -->
    {% if not errors %}
    <div class="bg-gray-50 p-6 rounded-lg mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Simulation Parameters</h2>
        <form method="post" id="simulation-form">
            {% csrf_token %}
            <input type="hidden" name="portfolio" value="{{ selected_portfolio.id }}">

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-6">
                <div>
                    <label for="annual_contribution" class="block text-sm font-medium text-gray-700 mb-2">
                        Annual Contribution
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                        <input type="number" name="annual_contribution" id="annual_contribution"
                               value="{{ simulation_params.annual_contribution|default:'0' }}"
                               min="0" step="1000"
                               class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Until retirement</p>
                </div>

                <div>
                    <label for="inflation_rate" class="block text-sm font-medium text-gray-700 mb-2">
                        Inflation Rate
                    </label>
                    <div class="relative">
                        <input type="number" name="inflation_rate" id="inflation_rate"
                               value="{{ simulation_params.inflation_rate|default:'3.0' }}"
                               min="0" max="100" step="0.1"
                               class="w-full pr-8 pl-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Annual rate</p>
                </div>

                <div>
                    <label for="withdrawal_amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Annual Withdrawal
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500" id="withdrawal-prefix">
                            {% if simulation_params.withdrawal_mode == 'dollar' %}${% else %}%{% endif %}
                        </span>
                        <input type="number" name="withdrawal_amount" id="withdrawal_amount"
                               value="{{ simulation_params.withdrawal_amount|default:'4.0' }}"
                               min="0" step="0.1"
                               class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">In retirement</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Withdrawal Mode
                    </label>
                    <div class="flex gap-2 mt-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="withdrawal_mode" value="percent"
                                   {% if simulation_params.withdrawal_mode == 'percent' or not simulation_params.withdrawal_mode %}checked{% endif %}
                                   onchange="updateWithdrawalPrefix()"
                                   class="form-radio h-4 w-4 text-indigo-600">
                            <span class="ml-1 text-sm text-gray-700">%</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="withdrawal_mode" value="dollar"
                                   {% if simulation_params.withdrawal_mode == 'dollar' %}checked{% endif %}
                                   onchange="updateWithdrawalPrefix()"
                                   class="form-radio h-4 w-4 text-indigo-600">
                            <span class="ml-1 text-sm text-gray-700">$</span>
                        </label>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">&nbsp;</p>
                </div>

                <div>
                    <label for="expected_lifespan" class="block text-sm font-medium text-gray-700 mb-2">
                        Expected Lifespan
                    </label>
                    <input type="number" name="expected_lifespan" id="expected_lifespan"
                           value="{{ simulation_params.expected_lifespan|default:'95' }}"
                           min="50" max="120" step="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">Age in years</p>
                </div>
            </div>

            <div class="flex justify-end">
                <button type="submit" id="run-simulation-btn"
                        class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium inline-flex items-center">
                    <span id="btn-text">Run Simulation</span>
                    <svg id="btn-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Simulation Results -->
    {% if simulation_results %}
    <div class="bg-white p-6 rounded-lg mb-8 border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Monte Carlo Simulation Results</h2>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Probability of Success</p>
                <p class="text-3xl font-bold text-green-600">{{ simulation_results.probability_of_success|floatformat:1 }}%</p>
                <p class="text-xs text-gray-500 mt-1">Portfolio never runs out of money</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Additional Contribution</p>
                <p class="text-2xl font-bold text-indigo-600 font-mono">${{ simulation_results.total_additional_contributions|floatformat:2|intcomma }}</p>
                <p class="text-xs text-gray-500 mt-1">Total contributions until retirement</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Expected Balance at Retirement</p>
                <p class="text-2xl font-bold text-blue-600 font-mono">${{ simulation_results.expected_balance_at_retirement|floatformat:2|intcomma }}</p>
                <p class="text-xs text-gray-500 mt-1">Median across all simulations</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Annual Withdrawal</p>
                <p class="text-2xl font-bold text-orange-600 font-mono">${{ simulation_results.annual_withdrawal_at_retirement|floatformat:2|intcomma }}</p>
                <p class="text-xs text-gray-500 mt-1">At retirement (inflation-adjusted)</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600">Expected Balance at Age {{ simulation_params.expected_lifespan|default:'95' }}</p>
                <p class="text-2xl font-bold text-purple-600 font-mono">${{ simulation_results.expected_balance_at_end|floatformat:2|intcomma }}</p>
                <p class="text-xs text-gray-500 mt-1">Median across all simulations</p>
            </div>
        </div>

        <!-- Chart -->
        <div class="bg-white p-4 rounded-lg border border-gray-200">
            <canvas id="monteCarloChart" height="100"></canvas>
        </div>

        <!-- Disclaimer -->
        <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <p class="text-sm text-yellow-800">
                <strong>Important Disclaimer:</strong> This simulation is for educational purposes only and should not be considered financial advice.
                Past performance does not guarantee future results. The simulation does not account for taxes, fees, or life changes.
                Please consult a qualified financial advisor for personalized retirement planning.
            </p>
        </div>

        <!-- Assumptions -->
        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Simulation Assumptions</h3>
            <ul class="text-xs text-gray-600 space-y-1">
                <li><strong>Asset Class Returns (Mean / Std Dev):</strong></li>
                <li class="ml-4">• Stocks: 10% / 18% (based on historical S&P 500, 1926-2024)</li>
                <li class="ml-4">• Bonds: 4% / 6% (based on 10-year Treasury bonds)</li>
                <li class="ml-4">• Crypto: 15% / 60% (highly speculative, limited history)</li>
                <li class="ml-4">• Other: 3% / 5% (cash equivalents)</li>
                <li><strong>Number of Simulations:</strong> 1,000</li>
                <li><strong>Rebalancing:</strong> Annual rebalancing to glidepath target allocation</li>
                <li><strong>Returns Distribution:</strong> Normal (Gaussian) distribution</li>
            </ul>
        </div>
    </div>

    <script>
        // Chart rendering
        {% if simulation_results.chart_data %}
        const chartData = {{ simulation_results.chart_data|safe }};
        const ctx = document.getElementById('monteCarloChart').getContext('2d');
        const currentAge = {{ simulation_results.current_age }};
        const retirementAge = {{ simulation_results.retirement_age }};

        const ages = chartData.percentile_50.map(point => point[0]);
        const p10_values = chartData.percentile_10.map(point => point[1]);
        const p50_values = chartData.percentile_50.map(point => point[1]);
        const p90_values = chartData.percentile_90.map(point => point[1]);

        // Custom plugin to draw retirement line
        const retirementLinePlugin = {
            id: 'retirementLine',
            afterDraw: function(chart) {
                // Only draw if retirement is in the future
                if (currentAge >= retirementAge) {
                    return;
                }

                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;

                // Find the x position for the retirement age
                const retirementIndex = ages.indexOf(retirementAge);
                if (retirementIndex === -1) {
                    return; // Retirement age not in the data
                }

                const x = xAxis.getPixelForValue(retirementAge);
                const topY = yAxis.top;
                const bottomY = yAxis.bottom;

                // Draw the vertical line
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, topY);
                ctx.lineTo(x, bottomY);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.8)'; // Red color
                ctx.setLineDash([5, 5]); // Dashed line
                ctx.stroke();

                // Draw the label
                ctx.font = 'bold 12px sans-serif';
                ctx.fillStyle = 'rgba(239, 68, 68, 1)';
                ctx.textAlign = 'center';
                ctx.fillText('Retirement', x, topY - 5);

                ctx.restore();
            }
        };

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ages,
                datasets: [
                    {
                        label: '90th Percentile (Optimistic)',
                        data: p90_values,
                        borderColor: 'rgba(34, 197, 94, 0.8)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: '+1',
                        borderWidth: 2,
                        pointRadius: 0,
                    },
                    {
                        label: '50th Percentile (Median)',
                        data: p50_values,
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: '+1',
                        borderWidth: 3,
                        pointRadius: 0,
                    },
                    {
                        label: '10th Percentile (Pessimistic)',
                        data: p10_values,
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Portfolio Balance Projection',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '$' + context.parsed.y.toLocaleString(undefined, {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Age',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Portfolio Balance ($)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString(undefined, {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        },
                        beginAtZero: true
                    }
                }
            },
            plugins: [retirementLinePlugin]
        });
        {% endif %}
    </script>
    {% endif %}

    <script>
        function updateWithdrawalPrefix() {
            const withdrawalMode = document.querySelector('input[name="withdrawal_mode"]:checked').value;
            const prefix = document.getElementById('withdrawal-prefix');

            if (withdrawalMode === 'percent') {
                prefix.textContent = '%';
            } else {
                prefix.textContent = '$';
            }
        }

        // Handle form submission to show loading state
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('simulation-form');
            if (form) {
                form.addEventListener('submit', function() {
                    const btn = document.getElementById('run-simulation-btn');
                    const btnText = document.getElementById('btn-text');
                    const btnSpinner = document.getElementById('btn-spinner');

                    if (btn && btnText && btnSpinner) {
                        btn.disabled = true;
                        btn.classList.add('opacity-75', 'cursor-not-allowed');
                        btn.classList.remove('hover:bg-indigo-700');
                        btnText.textContent = 'Running Simulation...';
                        btnSpinner.classList.remove('hidden');
                    }
                });
            }
        });
    </script>
    {% endif %}
</div>
{% endblock %}
