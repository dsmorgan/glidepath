{% extends 'glidepath_app/base.html' %}
{% block title %}Glidepath - Settings{% endblock %}
{% block content %}

<!-- Users Section -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Users</h1>
        <a href="{% url 'user_add' %}" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            Add User
        </a>
    </div>

    {% if users %}
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100 border-b">
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Username</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Email</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Name</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Identity Provider</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Role</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Disabled</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-700">{{ user.username }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">{{ user.email }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">{{ user.name|default:"â€”" }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">{{ user.identity_provider.name|default:"Internal" }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {% if user.is_admin %}
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">Admin</span>
                        {% else %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">User</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {% if user.disabled %}
                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">Yes</span>
                        {% else %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">No</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 space-x-2">
                        <a href="{% url 'user_edit' user.id %}" class="text-indigo-600 hover:text-indigo-900">Edit</a>
                        <form method="post" action="{% url 'user_delete' user.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-600">No users configured yet. <a href="{% url 'user_add' %}" class="text-indigo-600 hover:underline">Create the first user</a></p>
    {% endif %}
</div>

<!-- Identity Providers Section -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Identity Providers</h1>
        <a href="{% url 'identity_provider_add' %}" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            Add Provider
        </a>
    </div>

    {% if identity_providers %}
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100 border-b">
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">ID</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Name</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Type</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Disabled</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for provider in identity_providers %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-700">{{ provider.id|truncatewords:2 }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">{{ provider.name }}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {% for value, label in provider.PROVIDER_TYPE_CHOICES %}
                            {% if provider.type == value %}{{ label }}{% endif %}
                        {% endfor %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {% if provider.disabled %}Yes{% else %}No{% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 space-x-2">
                        <a href="{% url 'identity_provider_edit' provider.id %}" class="text-indigo-600 hover:text-indigo-900">Edit</a>
                        <form method="post" action="{% url 'identity_provider_delete' provider.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this provider?');">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-600">No identity providers configured yet. <a href="{% url 'identity_provider_add' %}" class="text-indigo-600 hover:underline">Add an identity provider</a></p>
    {% endif %}
</div>

<!-- Funds Management Section -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Funds Management</h1>
        <a href="{% url 'download_funds_csv' %}" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
            Download Funds CSV
        </a>
    </div>

    <p class="text-gray-700 mb-6">
        Download all funds to CSV or upload a CSV file to bulk import funds.
        Upload format: ticker, name, category (as "Class:Category" or blank for Other), preference (1-256).
        Existing funds (by ticker) will be skipped.
    </p>

    {% if funds_upload_success %}
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
        <p class="text-green-700">{{ funds_upload_success }}</p>
    </div>
    {% endif %}

    {% if funds_upload_error %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <p class="text-red-700">{{ funds_upload_error }}</p>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" action="{% url 'upload_funds_csv' %}" class="space-y-4">
        {% csrf_token %}
        <div>
            <label for="funds-csv-file" class="block text-sm font-medium text-gray-700 mb-1">
                Upload Funds CSV
            </label>
            <input
                type="file"
                id="funds-csv-file"
                name="file"
                accept=".csv"
                required
                class="w-full border border-gray-300 rounded-md p-2 text-sm"
            />
        </div>
        <div class="flex justify-end">
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Upload CSV
            </button>
        </div>
    </form>
</div>

<!-- API Settings Section -->
<div class="bg-white shadow rounded-lg p-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">API Settings</h1>

    <p class="text-gray-700 mb-6">
        Configure API keys for financial data sources. These keys are required to query ticker information from external services.
        API keys are stored securely and can be left blank if you don't plan to use a particular service.
    </p>

    {% if success_message %}
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
        <p class="text-green-700">{{ success_message }}</p>
    </div>
    {% endif %}

    <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Alpha Vantage -->
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Alpha Vantage</h2>
            <p class="text-sm text-gray-600 mb-4">
                Official NASDAQ vendor with 500 free API calls per day. Supports historical data, fundamentals, technical indicators, forex, and crypto.
                <a href="https://www.alphavantage.co/support/#api-key" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">Get your free API key here</a>
            </p>
            <div>
                <label for="{{ form.alpha_vantage_api_key.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.alpha_vantage_api_key.label }}
                </label>
                {{ form.alpha_vantage_api_key }}
            </div>
        </div>

        <!-- Finnhub -->
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Finnhub</h2>
            <p class="text-sm text-gray-600 mb-4">
                Institutional-grade financial data including real-time stock prices, global fundamentals, and ETF holdings.
                <a href="https://finnhub.io/register" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">Sign up for a free API key</a>
            </p>
            <div>
                <label for="{{ form.finnhub_api_key.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.finnhub_api_key.label }}
                </label>
                {{ form.finnhub_api_key }}
            </div>
        </div>

        <!-- Polygon.io -->
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Polygon.io</h2>
            <p class="text-sm text-gray-600 mb-4">
                Real-time and historical market data with low latency (20ms avg). Unlimited usage on premium subscriptions.
                <a href="https://polygon.io/dashboard/signup" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">Sign up for an API key</a>
            </p>
            <div>
                <label for="{{ form.polygon_api_key.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.polygon_api_key.label }}
                </label>
                {{ form.polygon_api_key }}
            </div>
        </div>

        <!-- EODHD -->
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">EODHD</h2>
            <p class="text-sm text-gray-600 mb-4">
                Historical and fundamental financial data. Use "DEMO" as the API key to test with limited tickers (AAPL.US, TSLA.US, VTI.US, AMZN.US, BTC-USD, EUR-USD).
                <a href="https://eodhd.com/register" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">Register for a full API key</a>
            </p>
            <div>
                <label for="{{ form.eodhd_api_key.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.eodhd_api_key.label }}
                </label>
                {{ form.eodhd_api_key }}
            </div>
        </div>

        <div class="flex justify-end">
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Save Settings
            </button>
        </div>
    </form>

    <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">About API Keys</h3>
        <p class="text-sm text-blue-800">
            API keys are used to authenticate requests to external financial data providers. Each service has different rate limits and feature sets.
            Your API keys are stored locally and never shared with third parties. Visit the <a href="{% url 'funds' %}" class="underline font-medium">Funds</a> page to query ticker information using these services.
        </p>
    </div>
</div>
{% endblock %}
