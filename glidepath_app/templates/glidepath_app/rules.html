<div class="overflow-x-auto">
    <table class="min-w-full border">
        <thead class="bg-gray-100">
            <tr>
                <th class="px-2 py-1 border">gt-retire-age</th>
                <th class="px-2 py-1 border">lt-retire-age</th>
                <th class="px-2 py-1 border">Classes</th>
                <th class="px-2 py-1 border">Categories</th>
            </tr>
        </thead>
        <tbody>
        {% for rule in rules %}
            <tr class="odd:bg-white even:bg-gray-50">
                <td class="px-2 py-1 border">{{ rule.gt_retire_age }}</td>
                <td class="px-2 py-1 border">{{ rule.lt_retire_age }}</td>
                <td class="px-2 py-1 border">
                    {% for ca in rule.class_allocations.all %}
                        {{ ca.asset_class.name }}: {{ ca.percentage }}%<br>
                    {% endfor %}
                </td>
                <td class="px-2 py-1 border">
                    {% for ca in rule.category_allocations.all %}
                        {{ ca.asset_category.asset_class.name }}:{{ ca.asset_category.name }}: {{ ca.percentage }}%<br>
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<div class="mt-8 flex flex-wrap justify-center gap-4">
    <div class="w-full max-w-[50vw] md:w-1/2 lg:w-1/3 h-[33vh]">
        <canvas id="classChart" class="w-full h-full"></canvas>
    </div>
    <div class="w-full max-w-[50vw] md:w-1/2 lg:w-1/3 h-[33vh]">
        <canvas id="categoryChart" class="w-full h-full"></canvas>
    </div>
    <div class="w-full max-w-[50vw] md:w-1/2 lg:w-1/3 h-[33vh]">
        <canvas id="classPieChart" class="w-full h-full"></canvas>
    </div>
</div>
<script>
if (window._renderChartsCallback) {
    htmx.off('htmx:load', window._renderChartsCallback);
}
window._renderChartsCallback = function () {
    const classCanvas = document.getElementById('classChart');
    const categoryCanvas = document.getElementById('categoryChart');
    const pieCanvas = document.getElementById('classPieChart');
    if (!classCanvas || !categoryCanvas || !pieCanvas) {
        return;
    }
    if (window.classChart) {
        chartAdapter.destroy(window.classChart);
    }
    if (window.categoryChart) {
        chartAdapter.destroy(window.categoryChart);
    }
    if (window.classPieChart) {
        chartAdapter.destroy(window.classPieChart);
    }
    const retirePlugin = {
        id: 'retireLine',
        afterDraw(chart) {
            const index = chart.data.labels.indexOf('0');
            if (index !== -1) {
                const x = chart.scales.x.getPixelForValue(index);
                const ctx = chart.ctx;
                ctx.save();
                ctx.strokeStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(x, chart.chartArea.top);
                ctx.lineTo(x, chart.chartArea.bottom);
                ctx.stroke();
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText('Retirement', x, chart.chartArea.top - 5);
                ctx.restore();
            }
        }
    };
    const tooltip = {
        callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}%`
        }
    };
    const commonOpts = {
        plugins: { legend: { position: 'bottom' }, tooltip },
        scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => v + '%' } } },
        responsive: true,
        maintainAspectRatio: false
    };
    window.classChart = chartAdapter.init(
        classCanvas.getContext('2d'),
        { type: 'line', data: {{ class_chart|safe }}, options: commonOpts, plugins:[retirePlugin] }
    );
    window.categoryChart = chartAdapter.init(
        categoryCanvas.getContext('2d'),
        { type: 'line', data: {{ category_chart|safe }}, options: commonOpts, plugins:[retirePlugin] }
    );
    const pieOpts = {
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: ctx => `${ctx.label}: ${ctx.parsed}%`
                }
            }
        },
        responsive: true,
        maintainAspectRatio: false
    };
    window.classPieChart = chartAdapter.init(
        pieCanvas.getContext('2d'),
        { type: 'pie', data: {{ class_pie_chart|safe }}, options: pieOpts }
    );
};
htmx.onLoad(window._renderChartsCallback);
</script>
